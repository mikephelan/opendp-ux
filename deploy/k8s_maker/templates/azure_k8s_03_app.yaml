---
# ---------------------------
# Test secret to get this running
# before deconstructing it
# ---------------------------
apiVersion: v1
kind: Secret
metadata:
  name: dpcreator-app-secrets
type: Opaque
stringData:
  secret-key: "SECRET_KEY!-ADD-REAL-KEY-HERE!--ADD-REAL-KEY!1234!"
  cryptography-key: "CRYPTOGRAPHY_KEY!-ADD-REAL-KEY!1234!"
---
# ----------------------------------------
# Configmap used for: dpcreator-app,
#   dpcreator-celery
# ----------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: dpcreator-app-configmap
data:
  #
  STATIC_ROOT: "/dpcreator_volume/static/dist"
  STATIC_URL: "/static/dist/"
  UPLOADED_FILE_STORAGE_ROOT: "/dpcreator_user_data"
  #
  # Should match the NGINX_MAX_UPLOAD_SIZE
  # ref: https://docs.djangoproject.com/en/3.2/ref/settings/#std:setting-DATA_UPLOAD_MAX_MEMORY_SIZE
  #  20971520 bytes = 20MB
  DATA_UPLOAD_MAX_MEMORY_SIZE: "20971520"
  #
  # Set to default of 2.5MB
  # ref: https://docs.djangoproject.com/en/3.2/ref/settings/#std:setting-FILE_UPLOAD_MAX_MEMORY_SIZE
  FILE_UPLOAD_MAX_MEMORY_SIZE: "2621440"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dpcreator-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dpcreator
      tier: app
  template:
    metadata:
      labels:
        app: dpcreator
        tier: app
    spec:
      #restartPolicy: Always
      volumes:
        - name: dpcreator-volume
          emptyDir: {}
          # azureDisk:
          #  kind: Managed
          #  diskName: storage-dpcreator-files
          #  diskURI:
      containers:
        # -------------------------------------------------
        # (1) Nginx frontend: Separate requests to static files vs. Django app
        # -------------------------------------------------
        - name: dpcreator-nginx
          image: {{ dpcreator_nginx_container }}:{{ dpcreator_container_tag }}
          imagePullPolicy: Always
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
          volumeMounts:
            # ----------------------------------
            # shared between containers
            # ----------------------------------
            - name: dpcreator-volume
              mountPath: /dpcreator_volume
              #subPath: 2ravens_org-apricot
              #readOnly: true
          #envFrom:
          #  - configMapRef:
          #      name: ravens-django-config-apricot
        # -------------------------------------------------
        # (2) Core application: Django + bundled static files
        # -------------------------------------------------
        - name: dpcreator-app
          image: {{ dpcreator_app_container }}:{{ dpcreator_container_tag }}
          imagePullPolicy: Always
          command: [ "azure_start_01.sh" ]
          #command: [ "/bin/sh" ]
          # args: [ "-c", "./migrate.sh && python manage.py runserver 0.0.0.0:8000"]
          ports:
            - name: dpcreator
              containerPort: 8000
              protocol: TCP
          volumeMounts:
            # ----------------------------------
            # shared between containers
            # ----------------------------------
            - name: dpcreator-volume
              mountPath: /dpcreator_volume
              #subPath: 2ravens_org-apricot
              #readOnly: false
          envFrom:
          - configMapRef:
              name: dpcreator-db-data-configmap
          - configMapRef:
              name: dpcreator-app-configmap
          env:
            - name: DJANGO_SETTINGS_MODULE
              value: opendp_project.settings_azure_test_01
            - name: ALLOWED_HOSTS
              value: "{{ ALLOWED_HOSTS }}"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-auth
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-auth
                  key: password
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: dpcreator-app-secrets
                  key: secret-key
            - name: CRYPTOGRAPHY_KEY
              valueFrom:
                secretKeyRef:
                  name: dpcreator-app-secrets
                  key: cryptography-key
---
# ---------------------------
# DPCreator - Service
# ---------------------------
apiVersion: v1
kind: Service
metadata:
  name: dpcreator-load-balancer
  labels:
    app: dpcreator
    tier: load-balancer
spec:
  type: LoadBalancer
  # IP mapped to dpcreator.2ravens.org
  loadBalancerIP: {{ loadBalancerIP }}
  selector:
    app: dpcreator
    tier: app
  ports:
  - port: 80
    # nginx port ->
    targetPort: 80
    # test - right to dpcreator-app port
    #targetPort: 8000
